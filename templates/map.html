<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>校园导航 - 最短路径</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 949px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        h1 {
            text-align: center;
            color: #2563eb;
            margin-bottom: 30px;
            font-size: 24px;
        }
        .form-wrapper {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .form-item {
            flex: 1;
            min-width: 200px;
        }
        .form-item label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-item select {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .form-item select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
        }
        .calc-btn {
            height: 40px;
            padding: 0 20px;
            background-color: #2563eb;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .calc-btn:hover {
            background-color: #1d4ed8;
        }
        .map-container {
            position: relative;
            width: 100%;
            max-width: 949px;
            height: 1030px;
            margin: 0 auto 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        .campus-bg {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #pathCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .result {
            padding: 20px;
            border-radius: 8px;
            background-color: #f9fafb;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }
        .path-text {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        .dist-text {
            font-size: 14px;
            color: #2563eb;
            font-weight: 500;
        }
        .error-text {
            color: #ef4444;
            font-size: 14px;
            text-align: center;
            padding: 10px;
            display: none;
        }
        .error-text.show {
            display: block;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>校园导航 - 最短路径</h1>
    <div class="form-wrapper">
        <div class="form-item">
            <label for="startNode">起点</label>
            <select id="startNode">
                <option value="">加载中...</option>
            </select>
        </div>
        <div class="form-item">
            <label for="endNode">终点</label>
            <select id="endNode">
                <option value="">加载中...</option>
            </select>
        </div>
        <button class="calc-btn" onclick="calculatePath()">计算最短路径</button>
    </div>

    <div class="map-container">
        <img src="map.png" class="campus-bg" alt="校园地图">
        <canvas id="pathCanvas" width="949" height="1030"></canvas>
    </div>

    <div class="result" id="resultBox">
        <div class="result-title">最短路径</div>
        <div class="path-text" id="pathText"></div>
        <div class="dist-text" id="distText"></div>
    </div>
    <div class="error-text" id="errorText"></div>
</div>

<script>
    // ========== 统一配置：API和页面路径 ==========
    const CONFIG = {
        // API配置
        API: {
            BASE_URL: AppConfig.API_BASE_URL,   // 后端服务地址
            NODES: "/api/nodes",                  // 获取节点接口
            SHORTEST_PATH: "/api/shortest-path"   // 最短路径接口
        }
    };
    
    // 向后兼容
    const API_BASE = CONFIG.API.BASE_URL;
    
    // 全局变量：存储后端返回的所有节点（建筑）
    let allBuildingNodes = {};
    const canvasSize = { width: 949, height: 1030 };
    let canvasCtx = null;

    // 页面初始化
    window.onload = function() {
        const canvas = document.getElementById("pathCanvas");
        canvasCtx = canvas.getContext("2d");
        loadBuildingNodes(); // 加载后端节点
        console.log("前端初始化完成，请求后端地址：", API_BASE);
    };

    // 加载后端的建筑节点（填充下拉框）
    function loadBuildingNodes() {
        console.log("加载建筑节点：", `${API_BASE}/api/nodes`);
        fetch(`${CONFIG.API.BASE_URL}${CONFIG.API.NODES}`)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP错误：${res.status}`);
                return res.json();
            })
            .then(nodes => {
                console.log("后端返回建筑节点：", nodes);
                // 存储节点（ID→节点信息）
                nodes.forEach(node => {
                    allBuildingNodes[node.id] = node;
                });
                // 填充下拉框
                const startSel = document.getElementById("startNode");
                const endSel = document.getElementById("endNode");
                startSel.innerHTML = "";
                endSel.innerHTML = "";
                // 添加空选项
                const emptyOpt = document.createElement("option");
                emptyOpt.value = "";
                emptyOpt.textContent = "请选择";
                startSel.appendChild(emptyOpt.cloneNode(true));
                endSel.appendChild(emptyOpt);
                // 添加建筑节点选项
                nodes.forEach(node => {
                    const opt = document.createElement("option");
                    opt.value = node.id;
                    opt.textContent = node.name;
                    startSel.appendChild(opt.cloneNode(true));
                    endSel.appendChild(opt);
                });
            })
            .catch(err => {
                console.error("节点加载失败：", err);
                showError("节点加载失败：" + err.message);
            });
    }

    // 计算最短路径（核心）
    async function calculatePath() {
        resetUI(); // 重置画布和状态
        const startId = document.getElementById("startNode").value;
        const endId = document.getElementById("endNode").value;

        // 基础校验
        if (!startId || !endId) {
            showError("请选择起点和终点！");
            return;
        }
        if (startId === endId) {
            showError("起点和终点不能相同！");
            return;
        }

        // 构造请求参数
        const requestData = { startId, endId };
        console.log("请求最短路径：", requestData);

        try {
            const res = await fetch(`${CONFIG.API.BASE_URL}${CONFIG.API.SHORTEST_PATH}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(requestData),
                mode: "cors"
            });

            if (!res.ok) throw new Error(`后端错误：${res.status} ${res.statusText}`);
            const result = await res.json();
            console.log("后端返回路径结果：", result);

            if (!result.success) {
                showError("路径计算失败：" + result.msg);
                return;
            }

            // 展示文字结果
            document.getElementById("pathText").textContent = result.PathNodeNames.join(" → ");
            document.getElementById("distText").textContent = `总距离：${result.TotalDist.toFixed(0)} 米`;
            document.getElementById("resultBox").classList.add("show");

            // 绘制路径（核心：用后端返回的坐标序列）
            drawPath(result.PathPoints, startId, endId);

        } catch (err) {
            console.error("路径请求失败：", err);
            showError("请求失败：" + err.message);
        }
    }

    // 绘制路径（全用后端返回的坐标）
    function drawPath(pathPoints, startId, endId) {
        if (!pathPoints || pathPoints.length === 0) {
            showError("后端未返回路径坐标");
            return;
        }
        console.log("绘制路径坐标：", pathPoints);

        // 1. 绘制路径折线（沿后端返回的坐标）
        canvasCtx.beginPath();
        // 移动到第一个坐标点
        const firstPoint = pathPoints[0];
        canvasCtx.moveTo(firstPoint[0], firstPoint[1]);
        // 依次连接所有坐标点
        for (let i = 1; i < pathPoints.length; i++) {
            const point = pathPoints[i];
            canvasCtx.lineTo(point[0], point[1]);
        }
        // 路径样式
        canvasCtx.strokeStyle = "#f59e0b"; // 黄色
        canvasCtx.lineWidth = 6;
        canvasCtx.lineCap = "round";
        canvasCtx.stroke();

        // 2. 绘制起点标记（用后端返回的起点坐标）
        drawMarker(allBuildingNodes[startId].point[0], allBuildingNodes[startId].point[1], "#ef4444", "起点", allBuildingNodes[startId].name);
        // 3. 绘制终点标记（用后端返回的终点坐标）
        drawMarker(allBuildingNodes[endId].point[0], allBuildingNodes[endId].point[1], "#2563eb", "终点", allBuildingNodes[endId].name);
    }

    // 绘制起点/终点标记（通用方法）
    function drawMarker(x, y, color, label, name) {
        // 圆形标记
        canvasCtx.beginPath();
        canvasCtx.arc(x, y, 12, 0, Math.PI * 2);
        canvasCtx.fillStyle = color;
        canvasCtx.fill();
        // 标记文字（起点/终点）
        canvasCtx.fillStyle = "#fff";
        canvasCtx.font = "14px Microsoft Yahei";
        canvasCtx.textAlign = "center";
        canvasCtx.textBaseline = "middle";
        canvasCtx.fillText(label, x, y);
        // 节点名称
        canvasCtx.fillStyle = color;
        canvasCtx.font = "12px Microsoft Yahei";
        canvasCtx.textBaseline = "top";
        canvasCtx.fillText(name, x, y + 18);
    }

    // 重置UI状态
    function resetUI() {
        canvasCtx.clearRect(0, 0, canvasSize.width, canvasSize.height);
        document.getElementById("resultBox").classList.remove("show");
        document.getElementById("errorText").classList.remove("show");
    }

    // 显示错误提示
    function showError(msg) {
        const el = document.getElementById("errorText");
        el.textContent = msg;
        el.classList.add("show");
        console.error("错误提示：", msg);
    }
</script>
</body>
</html>